ALTER TABLE MANITOU_TEST.APEX$_WS_FILES
 DROP PRIMARY KEY CASCADE;

DROP TABLE MANITOU_TEST.APEX$_WS_FILES CASCADE CONSTRAINTS;

CREATE TABLE MANITOU_TEST.APEX$_WS_FILES
(
  ID                   NUMBER,
  WS_APP_ID            NUMBER                   NOT NULL,
  DATA_GRID_ID         NUMBER,
  ROW_ID               NUMBER,
  WEBPAGE_ID           NUMBER,
  COMPONENT_LEVEL      VARCHAR2(30 BYTE),
  NAME                 VARCHAR2(255 BYTE)       NOT NULL,
  IMAGE_ALIAS          VARCHAR2(255 BYTE),
  IMAGE_ATTRIBUTES     VARCHAR2(255 BYTE),
  CONTENT              BLOB,
  CONTENT_LAST_UPDATE  DATE,
  MIME_TYPE            VARCHAR2(255 BYTE)       NOT NULL,
  CONTENT_CHARSET      VARCHAR2(255 BYTE),
  CONTENT_FILENAME     VARCHAR2(500 BYTE),
  DESCRIPTION          VARCHAR2(4000 BYTE),
  CREATED_ON           DATE                     NOT NULL,
  CREATED_BY           VARCHAR2(255 BYTE)       NOT NULL,
  UPDATED_ON           DATE,
  UPDATED_BY           VARCHAR2(255 BYTE)
)
LOB (CONTENT) STORE AS BASICFILE (
  TABLESPACE  USERS
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  RETENTION
  NOCACHE
  LOGGING
      STORAGE    (
                  INITIAL          64K
                  NEXT             1M
                  MINEXTENTS       1
                  MAXEXTENTS       UNLIMITED
                  PCTINCREASE      0
                  BUFFER_POOL      DEFAULT
                 ))
TABLESPACE USERS
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
MONITORING;


CREATE INDEX MANITOU_TEST.APEX$_WS_FILES_IDX1 ON MANITOU_TEST.APEX$_WS_FILES
(WS_APP_ID, DATA_GRID_ID, ROW_ID)
LOGGING
TABLESPACE USERS
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );

CREATE INDEX MANITOU_TEST.APEX$_WS_FILES_IDX2 ON MANITOU_TEST.APEX$_WS_FILES
(WS_APP_ID, WEBPAGE_ID)
LOGGING
TABLESPACE USERS
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );

CREATE UNIQUE INDEX MANITOU_TEST.APEX$_WS_FILES_PK ON MANITOU_TEST.APEX$_WS_FILES
(ID)
LOGGING
TABLESPACE USERS
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );

CREATE OR REPLACE TRIGGER MANITOU_TEST."APEX$_WS_FILES_T1"
before insert or update on "APEX$_WS_FILES"
for each row
begin
    --
    -- maintain pk and timestamps
    --
    if inserting and :new.id is null then
        select to_number(sys_guid(),'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX') into :new.id from dual;
    end if;
    if inserting and :new.image_alias is null then
        :new.image_alias := :new.name;
    end if;
    if inserting then
        :new.created_on := sysdate;
        :new.created_by := nvl(v('APP_USER'),user);
        :new.updated_on := sysdate;
        :new.updated_by := nvl(v('APP_USER'),user);
        :new.content_last_update := sysdate;
    elsif updating then
        :new.updated_on := sysdate;
        :new.updated_by := nvl(v('APP_USER'),user);
        if nvl(length(:new.content),0) <> nvl(length(:old.content),0) then
            :new.content_last_update := sysdate;
        end if;
    end if;
end;
/


ALTER TABLE MANITOU_TEST.APEX$_WS_FILES ADD (
  CONSTRAINT APEX$_WS_FILES_CL_CK
  CHECK (component_level in ('WEBSHEET','ROW','WORKSPACE','WEBPAGE'))
  ENABLE VALIDATE,
  CONSTRAINT APEX$_WS_FILES_PK
  PRIMARY KEY
  (ID)
  USING INDEX MANITOU_TEST.APEX$_WS_FILES_PK
  ENABLE VALIDATE);

ALTER TABLE MANITOU_TEST.APEX$_WS_FILES ADD (
  CONSTRAINT APEX$_WS_FILES_FK 
  FOREIGN KEY (ROW_ID) 
  REFERENCES MANITOU_TEST.APEX$_WS_ROWS (ID)
  ON DELETE CASCADE
  ENABLE VALIDATE);
